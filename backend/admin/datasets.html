<!DOCTYPE html>
<html lang="en">
<head>

  <!-- Basic Page Needs
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta charset="utf-8">
  <title>LaastuAPI Admin</title>
  <meta name="description" content="">
  <meta name="author" content="">

  <!-- Mobile Specific Metas
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- FONT
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
<!--   <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">
 -->
  <!-- CSS
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/skeleton.css">
  <link rel="stylesheet" href="css/style.css">
  <style type="text/css">
    
    .icon{
      width: 1.5rem;
    }
  		 .tooltip{
   			display: inline;
    		position: relative;
    		font-size: 1.3rem;
		}
		
		.tooltip:hover:after{
    		background: #333;
    		background: rgba(0,0,0,.8);
    		border-radius: 5px;
    		bottom: 26px;
    		color: #fff;
    		content: attr(title);
    		left: 20%;
    		padding: 5px 15px;
    		position: absolute;
    		z-index: 98;
    		width: 150px;
		}
		
		.tooltip:hover:before{
    		border: solid;
    		border-color: #333 transparent;
    		border-width: 6px 6px 0 6px;
    		bottom: 20px;
    		content: "";
    		left: 50%;
    		position: absolute;
    		z-index: 99;
		}

		#terminal{
			width: 100%;
			height: 40rem;
			border: 0px solid black;
			padding: 0;
			margin: 0;


		}
  </style>

  <!-- Favicon
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link rel="icon" type="image/png" href="images/favicon.png">
  <script src="node_modules/jquery/dist/jquery.min.js" type="text/javascript"></script>

</head>
<body>
    <div class="container">
     
    <!-- /////////////////////////////////////////////// -->

      <div class="row"  style="padding:4rem 1rem 3rem 1rem">
        <div class="twelve columns" style="text-align: center;"><img src="images/logo.png" style="width: 80%;"/></div>
      </div>

    <!-- /////////////////////////////////////////////// -->

<!-- 
<?


 
foreach ($services as $prov) {

  if ($prov["status"]!="conf file not found" && $prov["id"]!="nimi"){

    ?>
        <div class="row" style="padding:2rem 1rem 0 1rem">
          <div class="twelve columns"><b><?=$prov["name"]?></b>
          </div>
        </div>

      <div class="row"  style="border-bottom: 1px solid black;padding:0rem 1rem 1rem 1rem">
          <div class="six columns"><a href="<?=$prov["url"]?>">Info</a>
            <?
            if (@$prov["wms_url"]){
              ?>
              / Browse: 
              <a href="wms_browser.php?wms_url=<?=rawurlencode($prov["wms_url"])?>&wms_service=wms" target="_blank">WMS</a>
              <a href="wms_browser.php?wms_url=<?=rawurlencode($prov["wms_url"])?>&wms_service=wfs" target="_blank">WFS</a>
              <?
            }
            ?>

          </div>
       
          <div class="six columns"><?
          if (count(@$prov["tables"])>0){
            ?><a href="download.php?id=<?=$prov["id"]?>&file=*" target="terminal">Download files</a><?
          }
          if (@$prov["update_frequency"]!="" && @$prov["update_frequency"]!="live"){
            ?> > <a href="update_sql.php?id=<?=$prov["id"]?>" target="terminal">Update SQL</a> <?
          }
          ?></div>

        </div>
        

    <? 


    foreach ($prov["tables"] as $table) {

      ///////////
  
      // NAME

      $name = $table["id"].".".$prov["type"];

      ///////////

      // FILENAME

      $filename = $sevices_path."/".$prov["id"]."/cache/".$table["id"].".".$prov["type"];

      ///////////

      // URL

      if(!@$table["url"] && @$prov["wms_url"] && @$table["wms_service"] && @$table["wms_layer"]){
        $table["url"] = build_wms_url($prov["wms_url"], $table["wms_service"], $table["wms_layer"]);
        $table["preview_url"] = build_wms_url($prov["wms_url"], $table["wms_service"], $table["wms_layer"],10);
       
      } else {
         $table["preview_url"] =  $table["url"];
      }

      $test_url = $sevices_path."/".$prov["id"]."/".$prov["id"].".php?test=1";


      ///////////

      // FILE EXISTS

      if (file_exists($filename)){
        $file_exists = 1;
      } else {
        $file_exists = 0;
      }

      ///////////

      // AGE

      if ($file_exists){
          $file_created = @filemtime($filename);
          $file_created_text = humanTiming($file_created);
      }
    

      ///////////

      // URL SIZE


      $url_size = remote_filesize($table["url"]);
      $url_size_text = human_filesize($url_size,0);
    
      ///////////

      // FILE SIZE   

      if ($file_exists){
          $file_size = filesize($filename);
      } else {
          $file_size = 0;
      }

      ///////////

      // SIZE DIFF       

      $file_size_text = human_filesize($file_size,0);
      $size_diff = $url_size - $file_size;


      ///////////


      ?>

      <div class="row" style="border-bottom: 1px solid black;padding:1rem">

        <div class="one column">
            <a href="<?=$test_url?>" class="tooltip" title="Preview local query!"><img src="images/preview.png" class="icon"/></a>
        </div>
 
        <div class="three columns">
            <?=$name?>
        </div>

        <div class="two columns" style="border-right:1px solid black">
          <a href="<?=$table["preview_url"]?>" class="tooltip" title="<?=$table["preview_url"]?>">URL</a> / <?=$url_size_text?>
        </div>

        <?

      if ($file_exists==0){

        ?>
        <div class="one column">
          <a href="#" class="tooltip" title="Local file not found!"><img src="images/not_found.png" class="icon"></a>
        </div>

        <?

      } else if ($size_diff == 0){

        ?>
        <div class="one column">
              <a href="#" class="tooltip" title="Local file up to date!"><img src="images/up-to-date.png" class="icon"></a>
        </div>

        <?

      } else {

        if ($size_diff>0){
          $size_diff = "+".(human_filesize($size_diff));
        }

         ?>
        <div class="one column">
              <a href="#" class="tooltip" title="Update available! <?=$size_diff?>"><img src="images/download_new.png" class="icon"></a>
        </div>

        <?

      }

      print "<div class=\"five columns\">\n";

      if ($file_exists==1){

        if ( (@$prov["type"]=="json" || @$prov["type"]=="geojson") && file_exists($sevices_path."/".$prov["id"]."/json_parser.php")){
          $json_parser_script = file_get_contents($sevices_path."/".$prov["id"]."/json_parser.php");
          if (strstr($json_parser_script, "json_parser_".$table["id"])){
            ?> > <a href="json_parser.php?service=<?=$prov["id"]?>&table_id=<?=$table["id"]?>&type=<?=$prov["type"]?>" target="terminal">JSON Parse</a> <?
          }
        }

       
        if (file_exists($sevices_path."/".$prov["id"]."/post_update.php")){
          ?> > <a href="<?=$sevices_path."/".$prov["id"]?>/post_update.php" target="terminal">Post-update</a><?
        }

     }

        print "</div>";



      ///////////

      // BUTTONS
    


      print "</div>";

    } 


/*


    



    print "</ul>";
*/

    ?>     

<?
  } // if not found

}



?>
<div class="row" style="margin-bottom: 2rem; margin-top: 2rem;">
	<div class="twelve columns" style="border: 1px solid black;padding:0rem">
		<iframe src="" name="terminal" id="terminal"></iframe>
	</div>
</div> -->

  </div>
<script type="text/javascript">
	
      $.getJSON('../config/datasets.json',function(datasets) {

          for (var i = 0; i < datasets.length; i++) {
            addProvider( datasets[i]);
            updateProvider(datasets[i]);
          }
            console.log(datasets);
      });



      function addProvider(provider){

        // Check already have the div
         var div_id = "#provider_" + provider.id + " ";
         if($(div_id).length){
          return;
         }


        var html = [];

        html.push('<div id="provider_'+ provider.id +'">')

        // row
        html.push('<div class="row" style="padding:2rem 1rem 0 1rem">');
        html.push(' <div class="twelve columns name"><b></b></div>');
        html.push('</div>');

        // row
        html.push('<div class="row" style="border-bottom: 1px solid black;padding:0rem 1rem 1rem 1rem">');
        html.push('<div class="six columns" class="url">');



        html.push('</div>');     

        html.push('</div>');
   
        // row

        html.push('</div>');

        $(".container").append( html.join("") );

        // Create datasets

        for (var i = 0; i < provider.datasets.length; i++) {
            createDataset(provider.id , provider.datasets[i]);
        }


      }

      ///////////////////////////////////////////////

      function createDataset(provider_id, dataset){

           // Check already have the div
           var div_id = "#provider_" + provider_id + " #dataset_"+dataset.id;
           if($(div_id).length){
            return;
           }


          var html = [];

          html.push('<div class="row" style="border-bottom: 1px solid black;padding:1rem" id="dataset_'+ dataset.id +'">');
          html.push('<div class="one column"><a href="" class="dataset_url tooltip" title="Preview local query!"><img src="images/preview.png" class="icon"/></a> </div>');
          html.push(' <div class="three columns"><b class="dataset_name">a</b></div>');
          html.push('</div>');

          $("#provider_" + provider_id).append( html.join("") );

          updateDataset(provider_id, dataset);


      }

      ///////////////////////////////////////////////

      function updateProvider(provider){

        var div_id = "#provider_" + provider.id + " ";

        $(div_id + " .name b").html( provider.meta.et.name + "<br/>");


          $(div_id + " .name").append('<a href="'+ provider.meta.et.url +'">Info</a>');
          $(div_id + " .name").append(' / Browse: <a href="wms_browser.php?wms_url='+ provider.meta.et.url +'&wms_service=wms">WMS</a>');
          $(div_id + " .name").append(' <a href="wms_browser.php?wms_url='+ provider.meta.et.url +'&wms_service=wfs">WFS</a>'); 



      }

      ///////////////////////////////////////////////

      function updateDataset(provider_id, dataset){

          var div_id = "#dataset_"+dataset.id; // "#provider_" + provider_id + " 
          console.log(div_id);
          $(div_id + " .dataset_name").html( dataset.id);
          $(div_id + " .dataset_url").attr("href", dataset.url);




      }


      ///////////////////////////////////////////////





















	
</script>

</body>
</html>
