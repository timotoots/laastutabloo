<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Tabloo WebGL</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<link rel="stylesheet" type="text/css" href="css/tabloo.css">

		<!-- Fit DIVs -->
		<script type="text/javascript" src="lib/fit.min.js"></script>
		<script type="text/javascript" src="js/tabloo_fit.js"></script>

		<script src="lib/node_modules/jquery/dist/jquery.min.js"></script>


		<!-- WebGL -->
		<script src="lib/node_modules/three/build/three.js"></script>
		<script src="lib/node_modules/three/examples/js/controls/OrbitControls.js"></script>
		<script src="lib/node_modules/three/examples/js/libs/stats.min.js"></script>
		<script src="js/tabloocontrol_webgl.js"></script>
		<script src="js/lib_animator.js"></script>
		<script src="lib/bundle.min.js"></script>

	</head>

<body id="body">

	<div id="controls">
		<a href="javascript://" onclick="tc.rotateLaast(4,5,1080,1,5000);">RO1</a>
		<a href="javascript://" onclick="tc.rotateLaast(4,5,-1080,-1,5000);">RO2</a>
		<a href="javascript://" onclick="tc.rotateRow(1,1080,1)">ROW</a>
		<a href="javascript://" onclick="tc.changeLetter(10,10,2)">L2</a>
		<a href="javascript://" onclick="tc.changeLetter(10,10,3)">L3</a>
	</div>

	<div id="content">
	    <div id="tabloo_wrapper"></div>
	</div>

	<!-- Run script -->
	<script type="text/javascript">

		var  ta, tc;
		var letters = {};

		var params = {
	      laastX: 27, // number of shingles X
	      laastY: 12 // number of shingles Y
	    };

	    function promiseLoadJson(url) {
      return fetch(url)
        .then(response => response.json());
    }
	

		promiseLoadJson("json/letters.json")
			.then(data => new Promise(function(resolve, reject) {
		   		console.log("Letters loaded");
		   		for (var i = 0; i < data.length; i++) {
				        letters[data[i].letter] = true;
				      }
		        resolve(data);
		    }))
		   .then(letters_mapping => new Promise(function(resolve, reject){
		   		ta = new TablooAnim({"runInBrowser":1,"letters":letters});
		   		tc = new TablooControl(params);
		   		tc.loadLetters(letters_mapping);
		   		console.log("Libraries loaded");
		   		resolve(true);
		   } )).then(a => new Promise(function(resolve, reject){
		   		console.log("Start!");
		   		start();
		   		resolve(true);
		   } ));

			function start(){
				getQueries();
			}




	  /////////////////////////////////////////////////////////////

	  var animations;

	  function getQueries(ehak,queries,language){

	    var url = "json/slides.json";
	    url =  "http://laastutabloo.erm.ee:5000/render_query?query_id=avalik&ehak=446";

	    $.getJSON( url, function( data ) {

	      animations = ta.animateQueries(data);

	      for (var i = 0; i < animations.length; i++) {
	      	setTimeout(function(queue){ tc.runQueue(queue)}, 5000*i,animations[i]);
	      }

	    });

	  } // function


	  /////////////////////////////////////////////////////////////

	</script>

</body>
</html>
